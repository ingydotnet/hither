#!/usr/bin/env perl
use strict; use warnings;
use YAML::XS;

# my $metafile = $ENV{HITHER_METADATA} or die;

sub main {
  my $yaml = read_input();
  my $hsd = Load $yaml;
  write_head();
  my $tables = $hsd->{table} || die;
  for my $table (@$tables) {
    write_table_class($table);
  }
}

sub write_head {
  print <<'...';
# DO NOT EDIT. Generated by Hither.

from django.db import models

...
}

sub write_table_class {
  my $table = shift;
  my $class_name = $table->{name};
  $class_name = ucfirst $class_name;
  $class_name =~ s/_([a-z])/\u$1/g;
  my $columns = $table->{cols} || [];
  print <<"...";
class $class_name(models.Model):
...
  for my $column (sort {$a->{name} cmp $b->{name}} @$columns) {
    write_column($column);
  }
  print "\n";
}

my $type_to_field = {
  array => 'CharField',
  bigint => 'IntegerField',
  boolean => 'BooleanField',
  character => 'CharField',
  date => 'DateField',
  integer => 'IntegerField',
  money => 'CharField',
  numeric => 'FloatField',
  text => 'CharField',
  timestamp => 'TimeField',
};

sub write_column {
  my $column = shift;
  my $name = $column->{name};
  my $type = $column->{type};
  my $field = $type_to_field->{$type}
    or die "No field for type '$type'";
  print "    $name = models.$type()\n";
}

sub read_input {
  do {local $/; <>};
}

main();
